---

- name: rust | install Rust
  shell: "curl https://sh.rustup.rs -sSf | sh -s -- -y --no-modify-path"
  #                                                  │        └─ don't modify PATH on install
  #                                                  └─ non-interactive install
  tags:
    - rust
    - rustup
    - install

- name: rust | gather installed package information
  stat: >
    path="{{ rust_cargo_path }}/bin/{{ item }}"
    follow=yes
    get_checksum=no
    get_md5=no
  with_items: "{{ rust_packages }}"
  register: rust_package_stats
  tags:
    - rust

- name: rust | install global packages
  shell: >
    cargo install --force "{{ item.item }}"
  with_items: "{{ rust_package_stats.results }}"
  when: not item.stat.exists
  tags:
    - rust
    - cargo
    - install

- name: rust | clone Rust source
  git: >
    repo="{{ rust_repo }}"
    dest="{{ rust_dest }}"
    version="{{ rust_version }}"
    depth=1
    update=no
  tags:
    - rust
    - install
    - update

- name: rust | clone dybuk
  git: >
    repo="https://github.com/ticki/dybuk.git"
    dest="{{ rust_dybuk_dest }}"
    depth=1
    update=no
  tags:
    - rust
    - install
    - dybuk

- name: rust | check if dybuk is installed
  stat: >
    path="{{ rust_cargo_path }}/bin/dybuk"
    follow=yes
    get_checksum=no
    get_md5=no
  register: rust_dybuk_stat
  tags:
    - rust
    - dybuk

- name: rust | install dybuk
  shell: >
    cargo install --path .
    chdir="{{ rust_dybuk_dest }}"
  when: not rust_dybuk_stat.stat.exists
  tags:
    - rust
    - install
    - dybuk
